<!--

  Built by Eric Mill:
    eric@konklone.com   https://konklone.com   twitter.com/konklone

  With majestic assistance from Micah Rich (@micahbrich) and Brandon Jones (@btj).

  * Best with a mouse.
  * Open up the developer console.

  Bug reports and stuff:
    github.com/isitchristmas/web/issues

  Data from the past:
    github.com/isitchristmas/data

-->

<!doctype html>
<html lang="en">
<head>
  <link rel="authors" href="/humans.txt" />
  <link rel="warrant canary" href="/canary.txt" />

  <meta charset="utf-8" />
  <title>Is it Christmas?</title>

  <link rel="alternate" title="Is It Christmas?" href="/rss.xml" type="application/rss+xml" />

  <meta property="twitter:account_id" content="5232171" />

  <style type="text/css">
    html, body {height: 100%;}
    body {text-align: center;}

    a#answer {
      display: inline-block;
      margin-top: 200px;
      font-weight: bold;
      font-size: 120pt;
      font-family: Arial, sans-serif;
      text-decoration: none;
      color: black;
    }

    .flag {
      position: absolute;
      cursor: none;

      border: 1px solid #d6d6d6;

      -webkit-border-radius: 2px;
           -o-border-radius: 2px;
              border-radius: 2px;
    }
    .flag.ghost {opacity: 0.4;}
    .flag.me {pointer-events: none;}

    .click {
      position: absolute;
      border: 1px solid #000;

      -webkit-border-radius: 3px;
              border-radius: 3px;

      -webkit-transition: 0.5s ease-out;
         -moz-transition: 0.5s ease-out;
           -o-transition: 0.5s ease-out;
              transition: 0.5s ease-out;
    }

    #legend {
      position: fixed;
      top: 0; right: 0;
      width: 200px;
      padding-right: 15px; padding-top: 5px;
      text-align: right;
      font-size: 10pt;
    }
  </style>

  <script type="text/javascript" src="/js/christmas.js"></script>

  <!--[if IE 9 ]>
    <script type="text/javascript">window._ie9 = true;</script>
  <![endif]-->
  <!--[if IE]>
    <script type="text/javascript">window._ie = true;</script>
  <![endif]-->
</head>

<body>
  <!--
    Initial 'title' and noscript values are server-side fallbacks,
    calculated with UTC, for clients who do not have JS enabled.
  -->
  <a id="answer"
    title="<%= answer %>">
    <noscript><%= answer %></noscript>
  </a>

  <div id="legend"></div>

  <!-- replace fallback data with locally calculated values -->
  <script type="text/javascript">
    var country = "<%= country %>";
    if (!(Christmas.countries[country] && Christmas.countries[country].width))
      country = "EO";

    var me = {
      country: country
    };

    var checkedAt; // store last check, to manage race conditions
    function updateChristmas(isIt) {
      me.christmas = isIt;

      var answer;
      if (isIt)
        answer = Christmas.yes(country);
      else
        answer = Christmas.no(country);

      var elem = document.getElementById('answer');
      elem.innerHTML = answer;
      elem.setAttribute("title", answer);

      checkedAt = Date.now();
    }

    updateChristmas(Christmas.isIt());
  </script>


  <% if (env == "production") { %>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-252618-5', 'isitchristmas.com');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');

    </script>
  <% } %>


  <!-- optional: interaction -->
  <script src="/js/browser.js"></script>
  <script src="/js/css.js"></script>
  <script src="/js/sockjs.min.js"></script>
  <script src="/js/emoji.js"></script>
  <script type="text/javascript">

    var socket;
    var others = {};

    var user = {
      log: {
        join: <%= config.log.join %>, // join/leave messages
        info: <%= config.log.info %>,   // default
        debug: <%= config.log.debug %>, // you know

        life: true,  // life and death events
        chat: true,  // chat messages
        system: true // messages from the system for the public
      },

      retry: {
        id: null, // the timeout id
        initial: 500, // milliseconds
        multiplier: 2, // multiply after every retry
        current: 500 // will change
      },

      // values will be overwritten on hello in production
      live: {
        mouse_rate: 20,
        heartbeat_interval: 3000,
        death_interval: 6000,
        chat: "true",

        ghost_duration: 2000,
        ghost_max: 10,


      }
    };

    me.flag = null;
    me.ghosts = 0;
    me.angle = 0;
    me.alreadyArrived = false;

    // sockjs server endpoint
    <% if (req.param("streaming")) { %>
      var url = "<%= req.param("streaming") %>/christmas";
    <% } else { %>
      <% var random = Math.floor(Math.random() * config.streaming.length); %>
      var url = "<%= config.streaming[random] %>/christmas";
    <% } %>

    // whether activity is visible to the user
    var visible = <%= (req.param("visible") || config.visible) ? "true" : "false" %>;

    // whether to force into readonly mode (see mice, but no sending of own action)
    var force_readonly = <%= req.param("readonly") || "false" %>;

    // force it to use a particular transport
    var transport = "<%= req.param("transport") || "" %>";

    // allowed transports
    var default_transports = [
      "websocket", // most everyone nowadays
      "xhr-streaming", // older versions of non-IE, and when networks block websockets
      "xdr-streaming" // IE9
    ];

    // tiny events/commands system
    var events = {};
    var commands = {};
    function on(event, func) {events[event] = func;}
    function command(cmd, func) {commands[cmd] = func;}
    function noop() {};

    // managing heartbeats
    var heartbeat, death;
    var suicide = false; // why would you do this

    var legend = document.getElementById("legend")
      , legendTimeout;

    var christmasTimer
      , christmasEndTimer;

    <% if (req.param("serverId")) { %>
      // tiny tapping system, send up serverId.
      // received packets will then be funneled from requested server,
      // through the connected server.
      var serverId = "<%= req.param('serverId') %>";

      // you've connected to an admin - it is requesting the ID of the
      // server you wish to tap.
      on('identify', function(data) {
        rawSend('identify:' + serverId);
      });
    <% } %>

    // reference: http://www.quirksmode.org/js/events_properties.html
    var ieMap = {1: "left", 4: "middle", 2: "right"};
    var elseMap = {0: "left", 1: "middle", 2: "right"};
    var clickMap = window._ie ? ieMap : elseMap;
    var clickbacks = {};


/**** basic connection and event management ***/

    function connect(host) {
      socket = new SockJS(host, null, {
        protocols_whitelist: transport ? [transport] : default_transports
      });

      socket.onopen = function() {
        log.info("= Connected via " + socket.protocol);

        me.transport = socket.protocol;

        // XDR doesn't have good enough upstream speed for mouse motion
        me.readonly = force_readonly || (me.transport == "xdr-streaming");

        // reset retry timer, we're in
        user.retry.current = user.retry.initial;
      };

      socket.onclose = onDeath;

      socket.onmessage = function(message) {
        var data = JSON.parse(message.data);
        (events[data._event] || noop)(data);
      };
    }

    var rawSend = function(message) {socket.send(message)};
    var limiters = {
      chat: ratelimit(rawSend, 500),
      motion: ratelimitLive(rawSend, 'mouse_rate'),

      // covers click, scroll, anything else
      default: ratelimit(rawSend, 20)
    };

    function emit(event, data) {
      if (!me.id || !me.transport) {
        log.info("= Weird state! Trying to emit events when I have no ID. :|")
        return;
      }

      data = data || {};
      data._event = event;
      var message = JSON.stringify(data);
      (limiters[event] || limiters.default)(message);
    }



/*** user join/leave management ***/

    on('hello', function(data) {
      log.info("= Assigned ID: " + data.user.id + " [on: " + data.server + "]");

      // used only directly by other clients when packets are blindly rebroadcast.
      // me.id will never be depended on by the server.
      me.id = data.user.id;

      // convenience only for console poking, can safely delete
      me.server = data.server;

      // for display only, never sent, is overwritten on server-validated rename
      me.name = data.user.name;

      // server-overridden client options
      for (var key in data.live)
        user.live[key] = data.live[key];

      if (user.live.chat == "true")
        welcomeUser();

      me.browser = BrowserDetect.browser;
      me.os = BrowserDetect.OS;
      me.version = BrowserDetect.version;

      // all users announce their info to the server and start a heartbeat
      emit('arrive', myHeart());

      // update me to indicate I've sent 'arrive' once
      // server will know that future connects are reconnects
      me.alreadyArrived = true;

      setHeartbeat();
      setCursor(me.country);

      document.onmousemove = mouseMove;
      document.onmousedown = mouseClick;
      document.onmousewheel = mouseWheel;
      document.addEventListener("DOMMouseScroll", mouseWheel, false);
      document.oncontextmenu = function() {return false};
    });

    // core user details
    var myHeart = function() {
      return {
        id: me.id, // used in rebroadcasting only
        alreadyArrived: me.alreadyArrived, // new or reconnect?
        country: me.country, // TODO: ditch, server-side
        transport: me.transport,
        browser: me.browser,
        version: me.version,
        os: me.os
      };
    };

    var onDeath = function() {
      log.life("= Disconnected! :(");

      clearTimeout(heartbeat);
      clearTimeout(death);

      for (var id in others)
        removeOther(id);

      document.onmousemove = null;
      document.onmousedown = null;
      document.onmousewheel = null;
      document.oncontextmenu = null;

      me.id = null;
      me.transport = null;
      me.time = null;
      if (me.flag && me.flag.parentElement)
        me.flag.parentElement.removeChild(me.flag);

      setRetry();
    };

    var setRetry = function() {
      log.life("= Retrying in " + user.retry.current + "ms...");
      user.retry.id = setTimeout(function() {
        connect(url);
      }, user.retry.current);

      user.retry.current = user.retry.current * user.retry.multiplier;
    }

    var setHeartbeat = function() {
      clearTimeout(heartbeat);
      heartbeat = setTimeout(function() {
        log.debug("heartbeat: beating");
        emit("heartbeat", myHeart());
      }, parseInt(user.live.heartbeat_interval));

      death = setTimeout(function() {
        log.life("= Died from lack of heartbeat :(")
        socket.close();
      }, parseInt(user.live.death_interval));
    };

    on("heartbeat", function(data) {
      if (suicide) return; // let death take me

      clearTimeout(death); // death averted
      log.debug("heartbeat: returned, death averted");

      setHeartbeat();
    });

    on('arrive', function(other) {
      registerOther(other);

      // let a new arrival know you are already here
      emit("here", {to: other.id});
    });

    on('here', function(other) {
      registerOther(other);
    });

    on('leave', function(data) {
      removeOther(data.id);
    });

    on('ping', function(data) {
      if (me.flag) {
        var x = parseInt(me.flag.style.left);
        var y = parseInt(me.flag.style.top);
        if (!isNaN(x) && !isNaN(y))
          emit("pong", {x: x, y: y});
      }
    })

    var registerOther = function(other) {
      if (others[other.id]) return;

      others[other.id] = {
        country: other.country,
        ghosts: 0,
        angle: 0
      };

      log.join("[" + other.id + "] Joined from " + other.country + " (" + Christmas.countries[other.country].name + ")");
    };

    // the creation of an element per-user is only sparked by that user's mouse motion.
    // so read-only (non-WS) clients will connect and be known, but not cause
    // elements to be generated.
    var showOther = function(other) {
      // make up for shortened key name
      other.country = other.country || other.c;

      // in case this comes before the 'arrive' event does
      registerOther(other);

      others[other.id].flag = flagFor(other.country, "other");
      if (visible)
        document.body.appendChild(others[other.id].flag);
    };

    var removeOther = function(id) {
      if (!others[id]) return;
      var country = others[id].country;

      var elem = others[id].flag;
      if (elem && elem.parentElement)
        elem.parentElement.removeChild(elem);

      delete others[id];
      log.join("[" + id + "] Departed from " + country + " (" + Christmas.countries[country].name + ")");
    };


/**** FLAG MECHANICS ***/

    var setCursor = function(country) {
      me.flag = flagFor(country, "me");
      me.flag._new = true; // used to lazy-add element only if moved
      me.flag.style.zIndex = 9999; // on top of the world
    };

    // [m|M]ozTransform is for older Firefox versions
    var setRotate = function(elem, angle) {
      if (!elem) return;
      elem.style.transform = elem.style.mozTransform = elem.style.MozTransform = elem.style.webkitTransform = elem.style.msTransform = "rotate(" + angle + "deg)";
    };

    var flagFor = function(country, klass) {
      var div = document.createElement('div');
      div.className = "flag " + klass;

      var flag = document.createElement('img');
      flag.src = "/countries/" + country + ".png";

      // create a legend in the top-right when you mouse over other people's flags
      if (klass == "other") {
        div.onmouseover = function() {
          clearTimeout(legendTimeout);
          legend.innerHTML = Christmas.countries[country].names.join("<br/>");
          legend.style.opacity = 1;
          legendTimeout = setTimeout(function() {
            legend.style.opacity = 0;
          }, 20000)
        };
      }

      div.appendChild(flag);

      // without this, div adds height padding, weird
      div.style.height = "20px";

      div.style.marginTop = "-10px"; // half of constant height 20
      div.style.marginLeft = "-" + (flagWidth(country) / 2) + "px";

      return div;
    };

    // there is sadly no international standard on flag aspect ratio
    var flagWidth = function(country) {
      return ((Christmas.countries[country] && Christmas.countries[country].width) || 40);
    }


    var mouseMove = function(event) {
      event = event || window.event;

      // only show it on first movement
      if (me.flag._new && visible && event.clientX && event.clientY) {
        document.body.appendChild(me.flag);
        document.body.style.cursor = "none";
        document.getElementById("answer").style.cursor = "none";
        me.flag._new = false;
      }

      moveFlag(me.flag,
        event.clientX + window.pageXOffset,
        event.clientY + window.pageYOffset
      );

      if (!me.readonly) {
        // is quick-rebroadcast, no server processing
        emit('motion', {
          x: event.clientX + window.pageXOffset,
          y: event.clientY + window.pageYOffset,
          id: me.id,
          c: me.country
        });
      }
    };

    on('motion', function(other) {
      // toss junk motion
      if (!(other.x && other.y)) return;

      if (!others[other.id] || !others[other.id].flag)
        showOther(other);

      moveFlag(others[other.id].flag, other.x, other.y);
    });

    var moveFlag = function(flag, x, y) {
      // check x and y to prevent motion on 0,0
      if (x && y) {
        flag.style.left = "" + x + "px";
        flag.style.top = "" + y + "px";
      }
    };

    var mouseWheel = function(event) {
      event = event || window.event;

      // how many clicks, and in which direction
      var direction;
      if (event.wheelDelta)
        direction = (event.wheelDelta > 0) ? 1 : -1;
      else if (event.detail && (event.detail != 0))
        direction = (event.detail > 0) ? -1 : 1;

      rotateFlag(me, direction);
      emit('scroll', {id: me.id, direction: direction});

      if (event.preventDefault) event.preventDefault();
      return false;
    }

    on('scroll', function(other) {
      // :(
      if (me.readonly || window._ie9) return;

      rotateFlag(others[other.id], other.direction);
    });

    var rotateFlag = function(person, direction) {
      var increment = 15;

      if (direction > 0)
        person.angle += increment;
      else
        person.angle -= increment;

      setRotate(person.flag, person.angle);
    };

    var mouseClick = function(event) {
      event = event || window.event;

      var button = clickMap[event.button];

      // :(
      if (me.readonly || window._ie9) return;

      var x = event.clientX + window.pageXOffset;
      var y = event.clientY + window.pageYOffset;

      clickbacks[button](me, x, y);

      // is quick-rebroadcast, no server processing
      emit('click', {x: x, y: y, id: me.id, button: button});
    };

    on('click', function(other) {
      // :(
      if (me.readonly || window._ie9) return;

      clickbacks[other.button](others[other.id], other.x, other.y);
    });

    clickbacks.left = function(person, x, y) {
      if (!visible) return;

      var elem = document.createElement("div");

      var width = flagWidth(person.country)
      var height = 20; // constant flag height
      var xOff = Math.floor(width / 2);
      var yOff = Math.floor(height / 2);

      elem.className = "click";
      elem.style.width = "" + width + "px";
      elem.style.height = "" + height + "px";
      elem.style.left = "" + (x - xOff) + "px";
      elem.style.top = "" + (y - yOff) + "px";

      setRotate(elem, person.angle);

      document.body.appendChild(elem);
      setTimeout(function() {
        elem.style.width = "" + (width*2) + "px";
        elem.style.height = "" + (height*2) + "px";
        elem.style.borderColor = "#fff";
        elem.style.left = "" + (x - width) + "px";
        elem.style.top = "" + (y - height) + "px";
        setTimeout(function() {
          elem.parentElement.removeChild(elem);
        }, 500);
      }, 10);
    };

    // create a translucent ghost flag
    clickbacks.right = function(person, x, y) {
      if (!visible) return;

      // enforce ghost cap
      if (person.ghosts >= user.live.ghost_max)
        return;

      var ghost = flagFor(person.country, "ghost");
      setRotate(ghost, person.angle);
      document.body.appendChild(ghost);
      moveFlag(ghost, x, y);
      person.ghosts += 1;

      // exists for 1s, fades for 1s
      setTimeout(function() {
        ghost.parentElement.removeChild(ghost);
        person.ghosts -= 1;
      }, user.live.ghost_duration);
    };

    clickbacks.middle = function(person, x, y) {
      person.angle = 0;
      setRotate(person.flag, 0);
    };


/**** Chat mechanics ****/

    // welcome user once, then after every 10 chat messages received.
    // turn off when the user first uses say().
    var said = false;
    var chatsSince = 0;

    var sayMyName = function() {
      var hello = "%cYour name is ";
      hello += "%c" + me.name;
      hello += "%c. Hello, ";
      hello += "%c" + me.name;
      hello += "%c.";
      console.log(hello, styles.system, styles.chat_my_name, styles.system, styles.chat_my_name, styles.system);
    }

    var welcomeUser = function() {
      if (user.log.system) {
        sayMyName();
        var spam = "%cPlease";
        spam += "%c don't spam and ruin the chat. I put a lot of work into this!";
        console.log(spam, styles.please, styles.spam);
        console.log(" ");

        console.log("%cCommands:", styles.help);
        var help1 = "%csay(\"message\")";
        help1 += "%c - Say a %cmessage %cto other people. (Include the quotes and parentheses!)";
        var help2 = "%crename(\"Name\")";
        help2 += "%c - Change to a new %cName%c. (Include the quotes and parentheses!)";
        var help3 = "%chelp%c - See this message again.";
        // help4 = "%cwhat%c - What??";
        console.log(help1, styles.help_bold, styles.help, styles.help_bold, styles.help);
        console.log(help2, styles.help_bold, styles.help, styles.help_bold, styles.help);
        console.log(help3, styles.help_bold, styles.help);
        // console.log(help4, styles.help_bold, styles.help);

        return ""; // when used via 'help'
      }
    };

    var say = function(message) {
      if (!message) return;
      if (user.live.chat != "true") return;

      said = true;
      emit('chat', {message: message});
      return blank();
    };

    var rename = function(name) {
      if (!name) return;
      emit('rename', {name: name})
      return blank();
    };

    on('rename', function(data) {
      me.name = data.name;
      if (user.log.system) sayMyName();
    });

    on('chat', function(data) {
      if (!said) {
        chatsSince += 1;
        if (chatsSince >= 10) {
          welcomeUser();
          chatsSince = 0;
        }
      }

      // avoid using logging system here, to do complex coloring
      if (user.log.chat) {
        var message = "%c   ";
        message += "%c " + data.name + ":";

        var emojis = [];
        while (found = Emoji.regexp.exec(data.message)) {
          emojis.push(styles.emoji(found[1]));
          emojis.push(styles.chat_message)
        };
        if (emojis.length > 0)
          data.message = data.message.replace(Emoji.regexp, "%c  %c");

        message += "%c " + data.message;

        console.log.apply(console, [
          message,
          styles.chat_flag(data.country),
          (data.id == me.id ? styles.chat_my_name : styles.chat_name),
          styles.chat_message
        ].concat(emojis));
      }
    });



/**** Admin powers ***/

    on('config', function(data) {
      log.info("= live config change: " + data.key + " [" + user.live[data.key] + " -> " + data.value + "]");
      user.live[data.key] = data.value;
    });

    on('command', function(data) {
      log.info("= command: " + data.command + " (" + data.arguments.join(",") + ")");
      (commands[data.command] || noop).apply(null, data.arguments);
    })

    command('blast', function(message) {
      log.system("= Server message: " + message);
    })

    command('reconnect', function() {
      log.system("= Server asked us to reconnect, closing connection");
      socket.close();
    });

    command('refresh', function() {
      log.system("= Server asked us to refresh, whooaaaaa");
      window.location = window.location;
    })


/**** rate limiting utilities **/

    // basic rate-limiter for a static value
    function ratelimit(fn, interval) {
      var last = (new Date()).getTime();
      return (function() {
        var now = (new Date()).getTime();
        if ((now - last) > interval) {
          last = now;
          return fn.apply(null, arguments);
        }
      });
    }

    // special version of ratelimit that looks to live-changeable value
    function ratelimitLive(fn, live) {
      var last = (new Date()).getTime();
      return (function() {
        var now = (new Date()).getTime();
        if ((now - last) > user.live[live]) {
          last = now;
          return fn.apply(null, arguments);
        }
      });
    }


/** christmas midnight effect **/

    // live flip when it's Xmas, and when it's not again
    var flagRule = addCSSRule(".flag");
    var clickRule = addCSSRule("div.click");
    var legendRule = addCSSRule("div#legend");
    function flagFade(centerTime) {
      // fade out, then in
      setTimeout(function() {
        flagRule.style.opacity = 0;
        legendRule.style.display = "none";
        clickRule.style.display = "none";

        setTimeout(function() {
          flagRule.style.opacity = 1;
          legendRule.style.display = "block";
          clickRule.style.display = "block";
        }, 5000); // 2 seconds after center

      }, (centerTime - Date.now()) - 3000); // 3 seconds before center (fade is 1s)
    }


    function setTimers() {
      var nextXmas = Christmas.thisYear();
      // var nextXmas = new Date(Date.now() + (5 * 1000)); // 5 seconds from now
      // var nextXmas = new Date(Date.now()); // pretend we showed up a few milliseconds before

      nextXmas = nextXmas.getTime();

      var afterXmas = nextXmas + (24 * 60 * 60 * 1000); // 1 day later
      // var afterXmas = nextXmas + (5 * 1000); // 10 seconds later

      // console.log("Christmas set for: " + new Date(nextXmas));
      // console.log("Christmas ends: " + new Date(afterXmas));

      if (checkedAt < nextXmas) {

        flagFade(nextXmas);

        christmasTimer = setTimeout(function() {
          console.log("%c" + Christmas.yes(country), styles.answer);
          updateChristmas(true);
        }, (nextXmas - Date.now()));
      }

      if (checkedAt < afterXmas) {

        flagFade(afterXmas);

        christmasEndTimer = setTimeout(function() {
          console.log("%c" + Christmas.no(country), styles.answer);
          updateChristmas(false);
        }, (afterXmas - Date.now()));
      }
    }


/**** minimalist logging system **/

    var log = function(message, severity, styles) {
      if (user.log[severity])
        console.log(message, styles);
    };

    log.styled = function(message, severity) {
      log("%c" + message, severity, styles[severity]);
    };

    log.debug = function(message) {log.styled(message, "debug")};
    log.info = function(message) {log.styled(message, "info")};
    log.join = function(message) {log.styled(message, "join")};
    log.system = function(message) {log.styled(message, "system")};
    log.life = function(message) {log.styled(message, "life")};
    // chat and christmas use own custom logging

    var styles = {
      debug: "color: #999999",
      join: "color: #999999",
      info: "color: #444444",
      system: "color: #336699",
      life: "color: #ff0000",
      chat_country: "color: #999999",
      chat_name: "color: #006600",
      chat_my_name: "color: #006600; font-weight: bold",
      chat_message: "color: #444444",
      spam: "color: #336699", // #990000 for urgency
      please: "color: #336699; font-weight: bold",
      help: "color: #630053",
      help_bold: "color: #630053; font-weight: bold",
      // how is this possible
      chat_flag: function(country) {
        return "background-image: url(\"https://isitchristmas.com/countries/" + country + ".png\"); background-size: cover; border: 1px solid #d6d6d6";
      },
      emoji: function(emoji) {
        return "background-image: url(\"https://isitchristmas.com/emojis/" + emoji + ".png\"); background-size: cover";
      },
      answer: "color: black; font-weight: bold; font-size: 120pt; text-transform: uppercase; font-family: Arial, sans-serif;"
    }


/**** misc and browser-specific fixes **/

    // if someone types just 'help', display help text.
    // side note: do people know you can do this??
    var help = function() {};
    help.toString = welcomeUser;

    // candy
    var candy = function() {};
    candy.toString = function() {window.location = "http://candybox2.net/";}

    var blank = function() {
      var nothing = function() {};
      nothing.toString = function() {return " "};
      return nothing;
    }

    // IE fix: make console.log be okay
    if (!window.console) window.console = {};
    if (!window.console.log) window.console.log = function() {};

    // Firefox fix: prevent ESC from closing websockets connection
    if (window.addEventListener)
      window.addEventListener('keydown', function(e) { (e.keyCode == 27 && e.preventDefault()) })

    // IE9 fix: XDR does not allow http->https communication, fall back to http
    if (window._ie9) url = url.replace("https", "http");

    // prevent click-drags from "grabbing" image
    document.body.onmousedown = function(event) {
      event = event || window.event;
      if (event.preventDefault) event.preventDefault();
      else event.returnValue = false;
    };


/**** GO ****/

    setTimers();
    connect(url);

  </script>
</body>
</html>